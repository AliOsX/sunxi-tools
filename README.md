#See the sunxi README (not this file) for details on how to use the sunxi tools


#Compiling as a library (libsunxi)

## Motivation
The sunxi tools (e.g. fel) are standalone executables. This is inconvenient in cases where we want to use them from within a program. It requires forking a shell process and piping the result back into the calling application. This kind of code is not portable across p1latforms (windows does not support forks and pipes)

## Problem
The sunxi C code does a few things that hamper their use in a library:
1. Use of assert() and exit() on errors
2. They have main() functions which would conflict with a calling applications main()
3. They write their output to stdout 

## Solutions
In an effort to touch the sunxi code as little as possible, the following was done
1. an #ifdef libsunxi refefines assert() and main() to call external functions throw_assert() and throw_exit() which are implemented in C++ as throws
2. #ifdef libsunxi renames the main function
3. stdout is duplicated in the calling code (i.e. not in sunxi code), and written to a temp file. After a call, this file is read and returned to the caller
 
libsunxi.cpp/.h contains necessary code for making the above solutions work. extern "C" is used as needed to ensure C-style linking



##Installing (Cross compiling to win32)
If you don't have them, you'll need the mingw cross-compiler toolchains:
```
sudo apt-get install mingw-w64 mingw-w64-tools
```
I did not put them in the install_windows.sh script

To install the repository and libusb, and build fel:
```
curl https://raw.githubusercontent.com/NextThingCo/sunxi-tools/windows/install_windows.sh | bash
```

Or, if you have the repository, just run install_windows.h. This will get the ming32 libusb library.

## Building
##Targets


*libsunxi* This builds libsunxi.a which, currently, is just the fel tool as a library. It also compresses the library and related files (pkgconfig stuff) into the dist directory so that other projects can grab it without having to build this projects

*fel-libsunxi* This builds an executable which is essentially the fel tools, but calling the library

Be sure and make clean if switching between cross compile platforms

./make_ubuntu.sh will prepare the environment and build the library for ubuntu
./make_windows.sh will prepare the environment and build the library for windows

##Windows USB Driver
The default windows USB driver will not recognize CHIP in fel mode. You must install one.
The repository https://github.com/NextThingCo/windowsUsbFelDriver contains a CHIP-fel mode compatible USB driver that was generated by the
libusbk project http://libusbk.sourceforge.net/UsbK3/index.html
